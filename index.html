<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Card Dinâmico Flexível (Métricas Opcionais)</title>
<style>
  /* CSS continua o mesmo de antes - omitido aqui por brevidade */
  body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f0f0; margin: 0;}
  .metric-card {background: linear-gradient(135deg, #aadd8e 0%, #6cb775 100%); color: white; padding: 25px; width: 320px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);}
  .card-title {font-size: 1.3em; font-weight: bold; text-align: left; margin-bottom: 20px; opacity: 0.9;}
  .main-metric-section {text-align: left; margin-bottom: 20px;}
  .trend-line-container {width: 100%; height: 40px; margin-bottom: 8px;}
  #trendLineSvg {width: 100%; height: 100%;}
  .main-metric-label {font-size: 0.95em; opacity: 0.85; margin-bottom: 5px;}
  .main-metric-value {font-size: 3.2em; font-weight: normal; line-height: 1.1;}
  .main-metric-value .value {font-weight: 700;}
  .main-metric-value .unit {font-size: 0.4em; font-weight: 600; margin-left: 5px; vertical-align: middle;}
  .separator {border: none; height: 1px; background-color: rgba(255, 255, 255, 0.5); margin-top: 15px; margin-bottom: 15px;}
  .secondary-metrics-section .secondary-metric {display: flex; justify-content: space-between; align-items: center; font-size: 1em; margin-bottom: 10px;}
  .secondary-metrics-section .secondary-metric:last-child {margin-bottom: 0;}
  .secondary-metric-label {opacity: 0.85;}
  .secondary-metric-value-container .value {font-weight: bold;}
  .secondary-metric-value-container .unit {font-size: 0.9em; margin-left: 4px; opacity: 0.9;}
</style>
</head>
<body>

<div class="metric-card">
  <div class="card-title" id="cardTitle"></div>
  <div class="main-metric-section">
    <div class="trend-line-container">
      <svg id="trendLineSvg" viewBox="0 0 100 30" preserveAspectRatio="none"></svg>
    </div>
    <div class="main-metric-label" id="mainMetricLabel"></div>
    <div class="main-metric-value" id="mainMetricValue"></div>
  </div>
  <hr class="separator">
  <div class="secondary-metrics-section">
    <div class="secondary-metric">
      <span class="secondary-metric-label" id="secondaryMetric1Label"></span>
      <span class="secondary-metric-value-container" id="secondaryMetric1Value"></span>
    </div>
    <div class="secondary-metric">
      <span class="secondary-metric-label" id="secondaryMetric2Label"></span>
      <span class="secondary-metric-value-container" id="secondaryMetric2Value"></span>
    </div>
  </div>
</div>

<script>
  // As funções drawTrendLine e updateCard continuam as mesmas de antes
  // Omitidas aqui por brevidade, mas elas devem estar presentes no seu código final.
  function drawTrendLine(svgElement, trendData) {
    svgElement.innerHTML = ''; 
    if (!trendData || trendData.length < 2) { /* ... código do placeholder ... */ const path = document.createElementNS("http://www.w3.org/2000/svg", "path"); path.setAttribute("d", "M5 20 Q 25 5, 45 12 T 75 10 L 95 8"); path.setAttribute("stroke", "white"); path.setAttribute("stroke-width", "3"); path.setAttribute("fill", "none"); path.setAttribute("stroke-linecap", "round"); path.setAttribute("stroke-linejoin", "round"); path.setAttribute("opacity", "0.7"); svgElement.appendChild(path); return; }
    const width = 100, height = 30, padding = 3;
    const dataMin = Math.min(...trendData), dataMax = Math.max(...trendData);
    const dataRange = (dataMax - dataMin === 0) ? 1 : (dataMax - dataMin);
    const points = trendData.map((d, i) => { const x = (i / (trendData.length - 1)) * (width - 2 * padding) + padding; const y = (height - padding) - ((d - dataMin) / dataRange) * (height - 2 * padding); return `${x.toFixed(2)},${y.toFixed(2)}`; }).join(" ");
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path"); path.setAttribute("d", `M${points}`); path.setAttribute("stroke", "white"); path.setAttribute("stroke-width", "3"); path.setAttribute("fill", "none"); path.setAttribute("stroke-linecap", "round"); path.setAttribute("stroke-linejoin", "round"); svgElement.appendChild(path);
  }

  function updateCard(data) {
    document.getElementById('cardTitle').textContent = data.title;
    document.getElementById('mainMetricLabel').textContent = data.mainMetric.label;
    const mainMetricValueElement = document.getElementById('mainMetricValue');
    mainMetricValueElement.innerHTML = `<strong class="value">${data.mainMetric.value}</strong> <span class="unit">${data.mainMetric.unit}</span>`;
    const svgElement = document.getElementById('trendLineSvg');
    drawTrendLine(svgElement, data.trendData);
    
    const secMetric1LabelEl = document.getElementById('secondaryMetric1Label');
    const secMetric1ValueEl = document.getElementById('secondaryMetric1Value');
    const secMetric2LabelEl = document.getElementById('secondaryMetric2Label');
    const secMetric2ValueEl = document.getElementById('secondaryMetric2Value');

    // Limpa as métricas secundárias antes de preencher
    secMetric1LabelEl.textContent = '';
    secMetric1ValueEl.innerHTML = '';
    secMetric2LabelEl.textContent = '';
    secMetric2ValueEl.innerHTML = '';

    if (data.secondaryMetrics && data.secondaryMetrics.length > 0) {
      if (data.secondaryMetrics[0]) {
        secMetric1LabelEl.textContent = data.secondaryMetrics[0].label;
        secMetric1ValueEl.innerHTML = `<strong class="value">${data.secondaryMetrics[0].value}</strong> <span class="unit">${data.secondaryMetrics[0].unit}</span>`;
      }
      if (data.secondaryMetrics[1]) {
        secMetric2LabelEl.textContent = data.secondaryMetrics[1].label;
        secMetric2ValueEl.innerHTML = `<strong class="value">${data.secondaryMetrics[1].value}</strong> <span class="unit">${data.secondaryMetrics[1].unit}</span>`;
      }
    }
  }
  // --- Início da Seção de Integração com SAS VA ---
  /*
  // Descomente a linha abaixo SE você não tiver incluído o script no <head>
  // <script src="/SASVisualAnalytics/resources/common/js/va-ddc-util.js"></script>
  if (window.SASVisualAnalytics && window.SASVisualAnalytics.adv && window.SASVisualAnalytics.adv.Observable) {
    vaDDCUtil.subscribeToData(handleVAData, { columns: 'all' }); 
  } else {
    console.warn("SAS VA DDC Util não encontrado. Usando dados de exemplo para Card Flexível.");
    document.addEventListener('DOMContentLoaded', function() {
      // Teste com dados mínimos (6 colunas)
      // const mockVaResponse = { data: sampleRows_Minimal, columns: mockColumns_Minimal };
      // Teste com 1 métrica secundária (9 colunas)
      const mockVaResponse = { data: sampleRows_WithOneSecondary, columns: mockColumns_WithOneSecondary };
      // Teste com todas as métricas (12 colunas)
      // const mockVaResponse = { data: sampleRows_Full, columns: mockColumns_Full };
      handleVAData(mockVaResponse);
    });
  }
  */

  function handleVAData(vaResponse) {
    console.log("Dados recebidos do SAS VA (Card Flexível):", vaResponse);

    if (!vaResponse || !vaResponse.data || vaResponse.data.length === 0 || !vaResponse.columns || vaResponse.columns.length === 0) {
      console.error("Estrutura de dados ou colunas ausente/vazia do SAS VA.");
      return;
    }

    const orderedActualColumnNames = vaResponse.columns.map(col => col.name);

    // DEFINA A ORDEM ESPERADA DAS COLUNAS (ÍNDICES)
    const IDX_TITULO = 0;
    const IDX_LABEL_PRINCIPAL = 1;
    const IDX_VALOR_PRINCIPAL = 2;
    const IDX_UNIDADE_PRINCIPAL = 3;
    const IDX_ANO_TENDENCIA = 4;     
    const IDX_VALOR_TENDENCIA = 5;   
    // Métricas secundárias são opcionais, mas se fornecidas, seus índices são:
    const IDX_LABEL_SEC1 = 6;        
    const IDX_VALOR_SEC1 = 7;        
    const IDX_UNIDADE_SEC1 = 8;      
    const IDX_LABEL_SEC2 = 9;        
    const IDX_VALOR_SEC2 = 10;       
    const IDX_UNIDADE_SEC2 = 11;     

    // Mínimo de colunas necessárias (para título, principal, e ano/valor da tendência)
    const MIN_COLUNAS_OBRIGATORIAS = IDX_VALOR_TENDENCIA + 1; // São 6 colunas (índices 0 a 5)

    if (orderedActualColumnNames.length < MIN_COLUNAS_OBRIGATORIAS) {
      console.error(`ERRO: O JavaScript espera pelo menos ${MIN_COLUNAS_OBRIGATORIAS} colunas para os dados básicos, mas o SAS VA enviou apenas ${orderedActualColumnNames.length}. Verifique as "Funções" obrigatórias.`);
      return;
    }

    const nomeColunaAnoTendencia = orderedActualColumnNames[IDX_ANO_TENDENCIA];
    const nomeColunaValorTendencia = orderedActualColumnNames[IDX_VALOR_TENDENCIA];
    const trendAnos = vaResponse.data.map(linha => linha[nomeColunaAnoTendencia]);
    const trendValoresMedida = vaResponse.data.map(linha => linha[nomeColunaValorTendencia]);
    console.log("Anos da tendência:", trendAnos);

    const primeiraLinha = vaResponse.data[0];
    const cardData = {
      title: primeiraLinha[orderedActualColumnNames[IDX_TITULO]] || "Título Padrão",
      mainMetric: {
        label: primeiraLinha[orderedActualColumnNames[IDX_LABEL_PRINCIPAL]] || "Variação",
        value: primeiraLinha[orderedActualColumnNames[IDX_VALOR_PRINCIPAL]] !== undefined ? String(primeiraLinha[orderedActualColumnNames[IDX_VALOR_PRINCIPAL]]).replace('.', ',') : "0,0",
        unit: primeiraLinha[orderedActualColumnNames[IDX_UNIDADE_PRINCIPAL]] || "p.p."
      },
      trendData: trendValoresMedida,
      secondaryMetrics: [] // Começa vazio, preenchemos condicionalmente
    };

    // Tenta preencher a Métrica Secundária 1 se houver colunas suficientes
    // O maior índice para a Métrica Secundária 1 é IDX_UNIDADE_SEC1
    if (orderedActualColumnNames.length > IDX_UNIDADE_SEC1) {
      cardData.secondaryMetrics.push({
        label: primeiraLinha[orderedActualColumnNames[IDX_LABEL_SEC1]] || "Métrica Sec. 1",
        value: primeiraLinha[orderedActualColumnNames[IDX_VALOR_SEC1]] !== undefined ? String(primeiraLinha[orderedActualColumnNames[IDX_VALOR_SEC1]]).replace('.', ',') : "",
        unit: primeiraLinha[orderedActualColumnNames[IDX_UNIDADE_SEC1]] || ""
      });

      // Tenta preencher a Métrica Secundária 2 se houver colunas suficientes E se a primeira já foi adicionada
      // O maior índice para a Métrica Secundária 2 é IDX_UNIDADE_SEC2
      if (orderedActualColumnNames.length > IDX_UNIDADE_SEC2) {
        cardData.secondaryMetrics.push({
          label: primeiraLinha[orderedActualColumnNames[IDX_LABEL_SEC2]] || "Métrica Sec. 2",
          value: primeiraLinha[orderedActualColumnNames[IDX_VALOR_SEC2]] !== undefined ? String(primeiraLinha[orderedActualColumnNames[IDX_VALOR_SEC2]]).replace('.', ',') : "",
          unit: primeiraLinha[orderedActualColumnNames[IDX_UNIDADE_SEC2]] || ""
        });
      }
    }
    updateCard(cardData);
  }
  // --- Fim da Seção de Integração com SAS VA ---

  // --- Dados e Colunas de Exemplo para TESTE LOCAL ---
  // Nomes de colunas para os dados de exemplo
  const exCol = {
      titulo: 'EX_TITULO', lblPrinc: 'EX_LBL_PRINC', valPrinc: 'EX_VAL_PRINC', uniPrinc: 'EX_UNI_PRINC',
      anoTend: 'EX_ANO_TEND', valTend: 'EX_VAL_TEND',
      lblSec1: 'EX_LBL_SEC1', valSec1: 'EX_VAL_SEC1', uniSec1: 'EX_UNI_SEC1',
      lblSec2: 'EX_LBL_SEC2', valSec2: 'EX_VAL_SEC2', uniSec2: 'EX_UNI_SEC2'
  };

  // 1. Exemplo com dados mínimos (6 colunas: título, principal, tendência ano/valor)
  const sampleRows_Minimal = [
    { [exCol.titulo]: "Card Mínimo", [exCol.lblPrinc]: "KPI Principal", [exCol.valPrinc]: "100", [exCol.uniPrinc]: "pts", [exCol.anoTend]: 2023, [exCol.valTend]: 50 },
    { [exCol.titulo]: "Card Mínimo", [exCol.lblPrinc]: "KPI Principal", [exCol.valPrinc]: "100", [exCol.uniPrinc]: "pts", [exCol.anoTend]: 2024, [exCol.valTend]: 55 }
  ];
  const mockColumns_Minimal = [
    { name: exCol.titulo, label: 'Título'}, { name: exCol.lblPrinc, label: 'Label Princ.'}, { name: exCol.valPrinc, label: 'Valor Princ.'}, 
    { name: exCol.uniPrinc, label: 'Unid. Princ.'}, { name: exCol.anoTend, label: 'Ano Tend.'}, { name: exCol.valTend, label: 'Valor Tend.'}
  ];

  // 2. Exemplo com 1 métrica secundária (9 colunas)
  const sampleRows_WithOneSecondary = [
    { [exCol.titulo]: "Card com 1 Sec.", [exCol.lblPrinc]: "KPI Principal", [exCol.valPrinc]: "200", [exCol.uniPrinc]: "€", [exCol.anoTend]: 2023, [exCol.valTend]: 60, [exCol.lblSec1]: "Info Extra", [exCol.valSec1]: "Detalhe A", [exCol.uniSec1]: "!" },
    { [exCol.titulo]: "Card com 1 Sec.", [exCol.lblPrinc]: "KPI Principal", [exCol.valPrinc]: "200", [exCol.uniPrinc]: "€", [exCol.anoTend]: 2024, [exCol.valTend]: 65, [exCol.lblSec1]: "Info Extra", [exCol.valSec1]: "Detalhe A", [exCol.uniSec1]: "!" }
  ];
  const mockColumns_WithOneSecondary = [
    ...mockColumns_Minimal, // As 6 primeiras
    { name: exCol.lblSec1, label: 'Label Sec1'}, { name: exCol.valSec1, label: 'Valor Sec1'}, { name: exCol.uniSec1, label: 'Unid. Sec1'}
  ];
  
  // 3. Exemplo com todas as métricas (12 colunas) - similar ao anterior, mas com mais colunas
  const sampleRows_Full = [
    { [exCol.titulo]: "Card Completo", [exCol.lblPrinc]: "KPI Completo", [exCol.valPrinc]: "300", [exCol.uniPrinc]: "$", [exCol.anoTend]: 2023, [exCol.valTend]: 70, [exCol.lblSec1]: "Secundária 1", [exCol.valSec1]: "S1 Val", [exCol.uniSec1]: "s1u", [exCol.lblSec2]: "Secundária 2", [exCol.valSec2]: "S2 Val", [exCol.uniSec2]: "s2u" },
    { [exCol.titulo]: "Card Completo", [exCol.lblPrinc]: "KPI Completo", [exCol.valPrinc]: "300", [exCol.uniPrinc]: "$", [exCol.anoTend]: 2024, [exCol.valTend]: 77, [exCol.lblSec1]: "Secundária 1", [exCol.valSec1]: "S1 Val", [exCol.uniSec1]: "s1u", [exCol.lblSec2]: "Secundária 2", [exCol.valSec2]: "S2 Val", [exCol.uniSec2]: "s2u" }
  ];
  const mockColumns_Full = [
    ...mockColumns_WithOneSecondary, // As 9 primeiras
    { name: exCol.lblSec2, label: 'Label Sec2'}, { name: exCol.valSec2, label: 'Valor Sec2'}, { name: exCol.uniSec2, label: 'Unid. Sec2'}
  ];


  if (!(window.SASVisualAnalytics && window.SASVisualAnalytics.adv && window.SASVisualAnalytics.adv.Observable)) {
    console.warn("SAS VA DDC Util não encontrado. Usando dados de exemplo para Card Flexível.");
    document.addEventListener('DOMContentLoaded', function() {
      // ESCOLHA QUAL EXEMPLO TESTAR LOCALMENTE DESCOMENTANDO UMA DAS LINHAS ABAIXO:
      const mockVaResponse = { data: sampleRows_Minimal, columns: mockColumns_Minimal };
      // const mockVaResponse = { data: sampleRows_WithOneSecondary, columns: mockColumns_WithOneSecondary };
      // const mockVaResponse = { data: sampleRows_Full, columns: mockColumns_Full };
      
      handleVAData(mockVaResponse);
    });
  }
</script>

</body>
</html>
